{% comment %}Search & Filter Section Component{% endcomment %}
<!-- Search & Filter Section -->
<section class="py-8 bg-gray-50 border-y border-gray-200">
    <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
            <!-- Search Bar -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <div class="flex-1 relative">
                    <input type="text" id="search-input" placeholder="Search for products, services..."
                           class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
                <button id="filter-toggle" class="px-6 py-3 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center justify-center gap-2">
                    <i class="fas fa-filter"></i>
                    <span>Filters</span>
                </button>
            </div>

            <!-- Filter Panel -->
            <div id="filter-panel" class="hidden bg-white border border-gray-200 rounded-lg p-6 mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Price Range -->
                    <div>
                        <h4 class="font-bold text-gray-800 mb-3">Price Range</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="price-filter" data-min="0" data-max="500" class="mr-2">
                                <span class="text-sm">Under KSH 500</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="price-filter" data-min="500" data-max="1000" class="mr-2">
                                <span class="text-sm">KSH 500 - 1,000</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="price-filter" data-min="1000" data-max="5000" class="mr-2">
                                <span class="text-sm">KSH 1,000 - 5,000</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="price-filter" data-min="5000" data-max="999999" class="mr-2">
                                <span class="text-sm">Above KSH 5,000</span>
                            </label>
                        </div>
                    </div>

                    <!-- Category -->
                    <div>
                        <h4 class="font-bold text-gray-800 mb-3">Category</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="category-filter" data-category="books" class="mr-2">
                                <span class="text-sm">Books</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="category-filter" data-category="merchandise" class="mr-2">
                                <span class="text-sm">Merchandise</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="category-filter" data-category="magazines" class="mr-2">
                                <span class="text-sm">Magazines</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="category-filter" data-category="services" class="mr-2">
                                <span class="text-sm">Services</span>
                            </label>
                        </div>
                    </div>

                    <!-- Sort By -->
                    <div>
                        <h4 class="font-bold text-gray-800 mb-3">Sort By</h4>
                        <select id="sort-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="featured">Featured</option>
                            <option value="price-low">Price: Low to High</option>
                            <option value="price-high">Price: High to Low</option>
                            <option value="newest">Newest First</option>
                            <option value="popular">Most Popular</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex gap-3">
                    <button id="apply-filters" class="px-6 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition">
                        Apply Filters
                    </button>
                    <button id="clear-filters" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                        Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. DOM Element References ---
        const filterToggleBtn = document.getElementById('filter-toggle');
        const filterPanel = document.getElementById('filter-panel');
        const searchInput = document.getElementById('search-input');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const clearFiltersBtn = document.getElementById('clear-filters');
        const sortSelect = document.getElementById('sort-select');
        const priceCheckboxes = document.querySelectorAll('.price-filter');
        const categoryCheckboxes = document.querySelectorAll('.category-filter');

        // --- 2. Filter Panel Toggle Functionality ---
        
        if (filterToggleBtn && filterPanel) {
            filterToggleBtn.addEventListener('click', () => {
                // Toggles the visibility of the filter panel using the Tailwind 'hidden' class
                filterPanel.classList.toggle('hidden');
                
                // Optional: Change the button's appearance/text to indicate state
                if (filterPanel.classList.contains('hidden')) {
                    filterToggleBtn.innerHTML = '<i class="fas fa-filter"></i> <span>Filters</span>';
                } else {
                    filterToggleBtn.innerHTML = '<i class="fas fa-times"></i> <span>Hide Filters</span>';
                }
            });
        }

        // --- 3. Core Filter Logic Function (Applied on Search/Apply) ---

        /**
         * Collects all current search and filter selections and initiates the search/filter process.
         */
        const executeSearchAndFilter = () => {
            const currentSearchTerm = searchInput ? searchInput.value.trim() : '';
            const currentSort = sortSelect ? sortSelect.value : 'featured';
            
            // Collect selected price ranges
            const selectedPriceRanges = Array.from(priceCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => ({
                    min: parseFloat(checkbox.dataset.min),
                    max: parseFloat(checkbox.dataset.max)
                }));
            
            // Collect selected categories
            const selectedCategories = Array.from(categoryCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.dataset.category);

            // Package all parameters
            const filterParams = {
                searchTerm: currentSearchTerm,
                sort: currentSort,
                priceRanges: selectedPriceRanges,
                categories: selectedCategories
            };

            // --- IMPORTANT: Send filterParams to your backend/data filtering function ---
            console.log('--- Applying Search and Filters ---');
            console.log('Parameters to send to server/filter function:', filterParams);
            
            // Example action: You would now fetch data or re-render your product grid
            // fetchProducts(filterParams); 
        };

        // --- 4. Event Listeners for Input Changes and Buttons ---

        // Listen for immediate search input changes (e.g., typing)
        if (searchInput) {
            // Optional: Implement a debounce/throttle function for better performance 
            // when typing, but for simplicity, we use the 'change' event for immediate search.
            searchInput.addEventListener('change', executeSearchAndFilter);
        }

        // Listen for filter checkboxes and sort selection changes
        const filterInputs = [...priceCheckboxes, ...categoryCheckboxes, sortSelect];
        filterInputs.forEach(input => {
            if (input) {
                input.addEventListener('change', () => {
                    // Optional: You could choose to execute the search immediately on change,
                    // or rely only on the 'Apply' button click below.
                    // console.log("Filter changed. Waiting for 'Apply'..."); 
                });
            }
        });

        // Apply Filters button listener
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', executeSearchAndFilter);
        }

        // Clear All Filters button listener
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', () => {
                // Reset search input
                if (searchInput) searchInput.value = '';
                
                // Uncheck all checkboxes
                priceCheckboxes.forEach(checkbox => checkbox.checked = false);
                categoryCheckboxes.forEach(checkbox => checkbox.checked = false);
                
                // Reset sort select to default
                if (sortSelect) sortSelect.value = 'featured';
                
                // After clearing the inputs, execute the search again to show all products
                executeSearchAndFilter(); 
                
                console.log('Filters cleared and search executed.');
            });
        }
    });
</script>