{% comment %}Cart Sidebar Component{% endcomment %}

<!-- Cart Sidebar -->
<div id="cart-sidebar" class="fixed top-0 right-0 h-full w-full md:w-[500px] bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300">
    <div class="flex flex-col h-full">
        <!-- Cart Header -->
        <div class="bg-sky-600 text-white p-6 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fas fa-shopping-cart text-2xl"></i>
                <h3 class="text-2xl font-bold">Shopping Cart</h3>
            </div>
            <button id="close-cart" class="text-white hover:text-gray-200 text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Cart Items -->
        <div id="cart-items" class="flex-1 overflow-y-auto p-6">
            <div id="empty-cart-message" class="text-center text-gray-500 py-12">
                <i class="fas fa-shopping-cart text-6xl mb-4 opacity-30"></i>
                <p class="text-lg">Your cart is empty</p>
                <p class="text-sm mt-2">Start adding items to your cart!</p>
            </div>

            <!-- Cart items will be dynamically added here -->
            <div id="cart-items-list" class="space-y-4 hidden">
                <!-- Sample cart item structure (will be generated by JS) -->
            </div>
        </div>

        <!-- Cart Actions -->
        <div class="border-t border-gray-200 p-4 bg-gray-50">
            <button id="clear-cart-btn" class="w-full bg-red-50 text-red-600 py-2 rounded-lg font-semibold hover:bg-red-100 transition mb-3 border border-red-200">
                <i class="fas fa-trash mr-2"></i>Clear Cart
            </button>
        </div>

        <!-- Payment Methods Section -->
        <div class="border-t border-gray-200 p-6 bg-white">
            <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-credit-card text-sky-600 mr-2"></i>
                Select Payment Method
            </h4>

            <div class="space-y-3 mb-4">
                <!-- Lipa na M-Pesa -->
                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-sky-500 transition">
                    <input type="radio" name="payment-method" value="mpesa" class="w-4 h-4 text-sky-600" checked>
                    <div class="ml-3 flex-1">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-mobile-alt text-green-600"></i>
                            <span class="font-semibold text-gray-800">Lipa na M-Pesa</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Pay instantly via M-Pesa</p>
                    </div>
                </label>

                <!-- Lipa Mdogo Mdogo (Installments) -->
                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-sky-500 transition">
                    <input type="radio" name="payment-method" value="installments" class="w-4 h-4 text-sky-600">
                    <div class="ml-3 flex-1">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-calendar-check text-blue-600"></i>
                            <span class="font-semibold text-gray-800">Lipa Mdogo Mdogo</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Pay in installments</p>
                    </div>
                </label>

                <!-- Pay Before Delivery -->
                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-sky-500 transition">
                    <input type="radio" name="payment-method" value="pay-before" class="w-4 h-4 text-sky-600">
                    <div class="ml-3 flex-1">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-purple-600"></i>
                            <span class="font-semibold text-gray-800">Pay Before Delivery</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Full payment before delivery</p>
                    </div>
                </label>

                <!-- Pay After Delivery (Cash on Delivery) -->
                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-sky-500 transition">
                    <input type="radio" name="payment-method" value="pay-after" class="w-4 h-4 text-sky-600">
                    <div class="ml-3 flex-1">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-hand-holding-usd text-orange-600"></i>
                            <span class="font-semibold text-gray-800">Pay After Delivery</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Cash on delivery</p>
                    </div>
                </label>

                <!-- Order Now (Contact for Payment) -->
                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-sky-500 transition">
                    <input type="radio" name="payment-method" value="order-now" class="w-4 h-4 text-sky-600">
                    <div class="ml-3 flex-1">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-phone text-sky-600"></i>
                            <span class="font-semibold text-gray-800">Order Now</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">We'll contact you for payment</p>
                    </div>
                </label>
            </div>
        </div>

        <!-- Cart Footer -->
        <div class="border-t border-gray-200 p-6 bg-gray-50">
            <div class="flex items-center justify-between mb-4">
                <span class="text-lg font-semibold text-gray-800">Total:</span>
                <span id="cart-total" class="text-2xl font-bold text-sky-600">KSH 0</span>
            </div>
            <button id="proceed-checkout-btn" class="w-full bg-sky-600 text-white py-4 rounded-lg font-bold hover:bg-sky-700 transition mb-2 shadow-lg">
                <i class="fas fa-credit-card mr-2"></i>Proceed to Checkout
            </button>
            <button id="continue-shopping" class="w-full bg-white text-sky-600 py-3 rounded-lg font-semibold hover:bg-gray-50 transition border border-sky-600">
                Continue Shopping
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // The main JavaScript file (berean_store.js) handles all cart functionality
        // This component script only handles the sidebar open/close functionality

        // --- 1. DOM Element References ---
        const cartSidebar = document.getElementById('cart-sidebar');
        const closeCartButton = document.getElementById('close-cart');
        const continueShoppingButton = document.getElementById('continue-shopping');

        // **IMPORTANT:** Replace 'open-cart-button' with the actual ID of your button
        // that is supposed to trigger the cart opening (e.g., a cart icon in your navbar).
        const openCartButton = document.getElementById('open-cart-button');

        // --- 2. Core Open/Close Functions ---

        /**
         * Opens the cart sidebar by removing the 'translate-x-full' class.
         */
        const openCart = () => {
            if (cartSidebar) {
                cartSidebar.classList.remove('translate-x-full');
            }
        };

        /**
         * Closes the cart sidebar by adding the 'translate-x-full' class.
         */
        const closeCart = () => {
            if (cartSidebar) {
                cartSidebar.classList.add('translate-x-full');
            }
        };

        // --- 3. Event Listeners ---

        // 3.1 Listeners for opening and closing the sidebar
        if (openCartButton) {
            openCartButton.addEventListener('click', openCart);
        }

        if (closeCartButton) {
            closeCartButton.addEventListener('click', closeCart);
        }

        if (continueShoppingButton) {
            continueShoppingButton.addEventListener('click', closeCart);
        }

        // 3.2 Optional: Close on ESC key press
        document.addEventListener('keydown', (event) => {
            // Check if the sidebar is visible (doesn't have the 'translate-x-full' class)
            if (event.key === 'Escape' && cartSidebar && !cartSidebar.classList.contains('translate-x-full')) {
                closeCart();
            }
        });

        // 3.3 Prevent closing when clicking inside the cart (standard for sidebars)
        if (cartSidebar) {
            cartSidebar.addEventListener('click', (event) => {
                // Stop click events from propagating past the cart sidebar,
                // which would typically be handled by a page-level backdrop
                event.stopPropagation();
            });
        }

        console.log('Cart sidebar component initialized - main JS handles cart functionality');
    });


    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. DOM Element References ---
        const cartSidebar = document.getElementById('cart-sidebar');
        const closeCartButton = document.getElementById('close-cart');
        const continueShoppingButton = document.getElementById('continue-shopping');
        const proceedCheckoutButton = document.getElementById('proceed-checkout-btn'); // Added this one
        const openCartButton = document.getElementById('open-cart-button');

        // --- 2. Core Open/Close Functions ---
        const openCart = () => {
            if (cartSidebar) {
                cartSidebar.classList.remove('translate-x-full');
            }
        };

        const closeCart = () => {
            if (cartSidebar) {
                cartSidebar.classList.add('translate-x-full');
            }
        };

        // --- 3. Checkout Logic Function (NEW) ---

        /**
         * Handles the "Proceed to Checkout" button click based on the selected payment method.
         */
        const handleCheckout = (event) => {
            event.preventDefault(); // Prevent default button action if it was a form submit

            // Get the selected payment method value
            const selectedPaymentMethod = document.querySelector('input[name="payment-method"]:checked');

            if (!selectedPaymentMethod) {
                alert('Please select a payment method before proceeding.');
                return;
            }

            const methodValue = selectedPaymentMethod.value;
            console.log('Selected Payment Method:', methodValue);

            // Logic based on your described payment steps:
            // "for mpesa & airtel, you'll be asked to give your naame, emails & phone..then 3rd step..Payment details[confirm your number]"

            if (methodValue === 'mpesa' || methodValue === 'installments' || methodValue === 'pay-before' || methodValue === 'pay-after' || methodValue === 'order-now') {
                // This corresponds to the flow asking for Name, Email, & Phone (Step 2 in your flow)
                alert('Step 1: Choose payment method (' + selectedPaymentMethod.nextElementSibling.querySelector('span').textContent.trim() + ') selected.\n\nProceeding to Step 2: Customer Information (Name, Email, Phone).');
                
                // **Actual implementation would be a redirect or a state change on a single-page app:**
                // window.location.href = '/checkout-customer-info'; 
            } else if (methodValue === 'cards') { 
                // This is for "Cards" as per your prompt, even though it's not in the current HTML.
                // Assuming you'd add it as an option.
                alert('Step 1: Cards selected.\n\nProceeding to Step 2: Billing Information & Payment Protocol.');
                
                // **Actual implementation:**
                // window.location.href = '/checkout-billing-info'; 
            } else {
                alert('Invalid or unhandled payment method selected.');
            }

            // Close the cart sidebar after initiating checkout
            closeCart();
        };

        // --- 4. Event Listeners ---

        // 4.1 Listeners for opening and closing the sidebar
        if (openCartButton) {
            openCartButton.addEventListener('click', openCart);
        }

        if (closeCartButton) {
            closeCartButton.addEventListener('click', closeCart);
        }

        if (continueShoppingButton) {
            continueShoppingButton.addEventListener('click', closeCart);
        }

        // 4.2 Listener for proceeding to checkout (NEW)
        if (proceedCheckoutButton) {
            proceedCheckoutButton.addEventListener('click', handleCheckout);
        }

        // 4.3 Optional: Close on ESC key press
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && cartSidebar && !cartSidebar.classList.contains('translate-x-full')) {
                closeCart();
            }
        });

        // 4.4 Prevent closing when clicking inside the cart (standard for sidebars)
        if (cartSidebar) {
            cartSidebar.addEventListener('click', (event) => {
                event.stopPropagation();
            });
        }

        console.log('Cart sidebar component initialized with checkout logic.');
    });
</script>